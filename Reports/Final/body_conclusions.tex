\chapter{Conclusions} % (fold)
\label{cha:conclusions}
\headermark{Conclusions}
\section*{} % (fold)
This section presents the conclusions gathered from this project, a summary of contributions and what may be done to extend and improve this work in the future.

\section{Conclusions}
The main objectives described in section~\ref{cha:problem_statement} have been fulfilled.

Generic guidelines and conventions for building highly performant and scalable Ruby on Rails applications have been created. The research performed to elaborate the technologies overview and the state of the art, exhibited in chapters~\ref{cha:technologies_review} and~\ref{cha:state_of_the_art}, supplied an important knowledge that shaped the initial decisions on what to further research. The conclusions drawn from the benchmarking phases of each component's analysis and their application to Escolinhas allowed to fill in some the flaws found in the initial research, providing a solid knowledge base for the elaboration of the aforementioned guidelines and conventions.

The native profiling tools for Ruby and Rails applications have been revamped and brought up to date. Rails' profiling tools were refactored in order to enable support for YARV, the official interpreter for Ruby 1.9. On the other hand, improvements were also made on YARV concerning this subject, by recording new information and enhancing its information retrieval capabilities.

The global awareness of the importance in building highly performant and scalable Ruby on Rails applications also increased. Revamping the native profiling tools, adding configuration options to YARV's garbage collector, writing a series of performance-oriented articles for Rails Magazine and developing an official benchmarking continuous integration suite for Rails, all contribute to an increased awareness on this matter, from the core team of Rails to the web developers. Given the performance benefits of the latest versions of Rails, porting Redmine to Rails 3 increases the visibility of these benefits since Redmine's users are able to experience it themselves. Finally, adding support for Ruby 1.9 and Rails 3 to some famous plugins also lowers the porting effort for some applications.

\section{Summary of Contributions}
The research and work performed in this thesis' context allowed to create new tools and contribute with new knowledge to the Ruby on Rails community.

First of all, generic guidelines and conventions on building highly performant and scalable Ruby on Rails applications were created. They are exhibited on appendix~\ref{GUIDELINES}, also being available on the internet\footnote{\url{URL DO GUIA}}.

Rails' native profiling and benchmarking tools got overhauled and now fully support Ruby 1.9.

Ruby 1.9's internal profiler was improved. It now stores more information than previously and is able to yield internal data in an appropriate format for automated processing---the \textit{hash} format---while still supporting the \textit{string} format. On another matter, its garbage collector is now flexible, offering five configuration parameters for adaptive performance.

Stephen Kaes' HTML printer for profiling Ruby applications was refactored to be compatible with recent Ruby interpreters, from 1.8.7 to 1.9.2. It was also integrated with the ``ruby-prof'' code profiler.

Escolinhas---the main test application---is now running on Ruby 1.9, notoriously benefiting from this version's performance improvements. Redmine---the aformentioned open-source project management tool---is now compatible with Rails 3, increasing the visibility of this version's benefits as a wide range of users are using this tool and are now able to personally experience the differences.

Some famous plugins---\textit{acts\_as\_list}, \textit{acts\_as\_paranoid} and \textit{permalink\_fu}---were refactored and now use the new Rails API thus being Rails 3 compatible. On a related matter, \textit{permalink\_fu} no longer requires Ruby 1.8 to function properly, as its character conversion engine has been completely rewritten and is now compatible with Ruby 1.9.

Published the first article of a performance-oriented series called ``Scaling Rails'' in \textit{Rails Magazine}.

Added partial support for lazy type casting to \textit{mysql2}, an emerging \textit{MySQL} Ruby library. In order to finalize this addition, missing support for some \textit{MySQL} types is currently being developed and tested.

A simple and lightweight utility for measuring the memory usage of multiple processes on UNIX systems was developed. A generic benchmarking script oriented towards operating system performance has also been developed. It uses third-party tools which are cross-platform compatible except for ``hdparm'', which is disabled if not running on a Linux system.

The performance of some Linux distributions---Ubuntu Server, Debian, CentOS and Gentoo---while performing generic tasks was analyzed, using the aforementioned benchmarking script. The performance of Ruby 1.8 and 1.9 was compared and demonstrated on multiple operating systems as well. Possible configuration options of Linux systems were also explored.

The performance of multiple Ruby web servers was exhaustively compared, including an analysis of some distinct configuration options found in each web server and their impact on its behavior.

Finally, explored the performance impact of some Ruby on Rails features, namely: eager loading, transactions, magic finders and fetching large groups of records.

\section{Future Research}
During the course of the project, many ideas were considered, but some of them could not have been pursued within the available time frame. This section presents some of these ideas.

\subsection{Approaching Non-Relational Databases}
The current research has focused on the ``Ruby component'' of the most popular database among Rails' developers---Ruby's \textit{MySQL} library. However, it would be interesting to explore the benefits of using a non-relational database, especially when taking into account the feedback some people are giving on the performance improvements these databases provide. Since these require the usage of specific ORM's, adding native support in Active Record for some of these databases---namely \textit{MongoDB} and \textit{CouchDB}---would probably increase their adoption among the developers.

\subsection{Generational Garbage Collection}
As previously mentioned, one of the main issues in Ruby, from the perspective of a Ruby on Rails applications, is its garbage collector. It is based on the simple \textit{mark-and-sweep} algorithm which is not very efficient for Rails applications, which frequently allocate and free considerable amounts of memory. Other interpreted languages such as Java and Python have a generational garbage collector, known for its superior efficiency. It would require a significant amount of effort to implement such algorithm on the Ruby interpreter since some C extensions rely on the current GC's behavior. However, it would be very interesting to analyze a working implementation of a generational garbage collector for Ruby from a performance standpoint.

\subsection{Partial Caching}
Caching is a recurring topic when optimizing a web application. Knowing that the database is often the major bottleneck found on a web application and also knowing that caching significantly decreases this bottleneck's impact, it would be interesting to add native caching support in Rails. While Rails has support for some famous tools like \textit{Memcached}\footnote{\url{http://memcached.org/}}, it natively lacks this support. Using third-party tools generally implies an extra effort since they are not as seamlessly integrated with Rails as a core component. \textit{Memcached}, for instance, requires that the developers use its methods to fetch the data from cache and use Rails' methods to fetch data from the database. It also requires that the developers explicitly store the data in the cache every single time it changes, none of it being automatic. However, if it was natively integrated, it would be possible to develop an optimized solution in which the developer would simply fetch the data, not needing to know if it was already cached, expired or any other quirk provoked from using two separate interfaces for fetching data, depending on its location. 

\subsection{Alternative Ruby Interpreters}
Many alternative Ruby interpreters are nearing 100\% compatibility with the Ruby 1.9 specification, namely \textit{JRuby} and \textit{Rubinius}. In a near future, these will be available as full-fledged Ruby implementations worth benchmarking and comparing with YARV, the official interpreter.

\subsection{Rewriting Web Servers in C}
Some of the most successful---namely Thin and Unicorn---Ruby web servers are mostly written in Ruby. As previously mentioned, Mongrel's performance is significantly superior to WEBrick's and the only difference is its reimplementation of the HTML parser in C. There is a high possibility that implementing some core parts of Thin and Unicorn in C would result in a significantly improved performance.


% Table generated by Excel2LaTeX from sheet 'Unicorn_Thin'
\begin{table}[htbp]
  \centering
  \caption{Add caption}
  \begin{tabular}{|c|c|c|c|c|c|}
  \hline
  Req. / Conc. & Page & Web Server & Requests/s (\#) & Total time (s) & Mem. Usage (B) \\ \hline
\multirow{6}{*}{50/1} & \multirow{2}{*}{Light} & Apache & \textbf{9.37} & \textbf{5.336} & 164429\\\cline{3-6}
 &  & Nginx & 9.1 & 5.496 & \textbf{154437}\\\cline{2-6}
 & \multirow{2}{*}{Heavy} & Apache & \textbf{1.18} & \textbf{42.494} & 154696\\\cline{3-6}
 &  & Nginx & 1.16 & 43.072 & \textbf{142983}\\\cline{2-6}
 & \multirow{2}{*}{Heaviest} & Apache & 6.24 & 8.017 & 185727\\\cline{3-6}
 &  & Nginx & \textbf{6.36} & \textbf{7.863} & \textbf{154383}\\\hline
\multirow{6}{*}{100/10} & \multirow{2}{*}{Light} & Apache & 12.06 & 8.294 & 207374\\\cline{3-6}
 &  & Nginx & \textbf{12.28} & \textbf{8.146} & \textbf{154453}\\\cline{2-6}
 & \multirow{2}{*}{Heavy} & Apache & \textbf{2.17} & \textbf{45.988} & 168179\\\cline{3-6}
 &  & Nginx & 2.1 & 47.634 & \textbf{156119}\\\cline{2-6}
 & \multirow{2}{*}{Heaviest} & Apache & \textbf{12.84} & \textbf{7.79} & 181126\\\cline{3-6}
 &  & Nginx & 11.94 & 8.375 & \textbf{149634}\\\hline
\multirow{6}{*}{500/50} & \multirow{2}{*}{Light} & Apache & \textbf{11.63} & \textbf{42.979} & 235130\\\cline{3-6}
 &  & Nginx & 11.53 & 43.383 & \textbf{141376}\\\cline{2-6}
 & \multirow{2}{*}{Heavy} & Apache & FAIL & FAIL & 207180\\\cline{3-6}
 &  & Nginx & \textbf{2.11} & \textbf{237.37} & \textbf{156234}\\\cline{2-6}
 & \multirow{2}{*}{Heaviest} & Apache & \textbf{12.49} & \textbf{40.043} & 200330\\\cline{3-6}
 &  & Nginx & 12.34 & 40.51 & \textbf{141514}\\\hline
\multirow{6}{*}{500/100} & \multirow{2}{*}{Light} & Apache & FAIL & FAIL & 255006\\\cline{3-6}
 &  & Nginx & \textbf{11.48} & \textbf{43.546} & \textbf{141438}\\\cline{2-6}
 & \multirow{2}{*}{Heavy} & Apache & FAIL & FAIL & 220525\\\cline{3-6}
 &  & Nginx & \textbf{2.1} & \textbf{238.16} & \textbf{156258}\\\cline{2-6}
 & \multirow{2}{*}{Heaviest} & Apache & FAIL & FAIL & 218195\\\cline{3-6}
 &  & Nginx & \textbf{12.42} & \textbf{40.273} & \textbf{154676}\\\hline
\multirow{6}{*}{2500/500} & \multirow{2}{*}{Light} & Apache & FAIL & FAIL & 238933\\\cline{3-6}
 &  & Nginx & FAIL & FAIL & \textbf{154599}\\\cline{2-6}
 & \multirow{2}{*}{Heavy} & Apache & FAIL & FAIL & 220258\\\cline{3-6}
 &  & Nginx & FAIL & FAIL & \textbf{143133}\\\cline{2-6}
 & \multirow{2}{*}{Heaviest} & Apache & FAIL & FAIL & 228932\\\cline{3-6}
 &  & Nginx & FAIL & FAIL & \textbf{154699}\\\hline
\multirow{2}{*}{Total} &  & Apache &  & \textbf{200.941} & 199825\\\cline{2-6}
 &  & Nginx &  & 204.479 & \textbf{150292}\\\hline
  \end{tabular}


  \label{tab:addlabel}
\end{table}
\begin{comment}
This is deprecated!!!!!!

The existing research provides a solid base for future work on this subject. The endured technology overview allowed the creation of an expectancy base for each component. The state of the art provided an overview of the current engaged work on related, if not similar, subjects.

All the gathered and structured information permitted option narrowing when it comes to future work. Taking into account the research and conclusions of some related work, some components will be left out of future benchmarking, tuning, testing and improvement.

On the Operating System's concern, Microsoft's operating system will be left out of future efforts since its Ruby and Rails support is significantly poor and inefficient. The lack of benchmark and testing information about BSD and the fact that its performance should be similar to Linux's include it in the test group. Concluding, the Operating Systems contempt by this project will be Linux and BSD.

Ruby is currently in version 1.9 which has many improvements over the previous version, both performance and not performance-oriented. Since YARV is the only one to support its specification to full extent, this will be the only interpreter targeted for improvements. Luckily, Rubinius' 1.9 support is growing day by day and it is close to 100\%. Only time will tell if this interpreter will be considered as well.

Rails web servers' situation is more flat. Only WEBrick is left out for obvious reasons --- it was Rails' pioneer web server but lacks the efficiency to compete with nowadays alternatives.

When it comes to relational databases, MySQL's scaling and performance capabilities shine. On the other hand, MongoDB presents itself as a worthy alternative but it has an important characteristic --- it is a schema-less database. PostgreSQL, although providing many interesting features, is not efficient enough to compete with MySQL, being left out of the test group for further work. MySQL and MongoDB are targeted for all the aforementioned improvement cycle.

Rails is growing fast and version 3 will soon to be publicly released. It solves many existing performance bottlenecks in Rails 2.3 and improves its predecessor code by a great deal. Working on Rails 2.3 would not be very productive since it will soon become deprecated and inefficient when compared with the most recent version. Version 3 will be the main target focus for further development.

The application itself, \textit{Escolinhas}, would benefit from huge performance gains just by being ported to Ruby 1.9 and Rails 3. The remaining improvements are dependant on the improvement cycles of all the components mentioned before, as performance bottlenecks must be found and solved on each setup.

Ultimately this research provided a careful overview over the involved technologies and their current state, sustaining the creation of a solid research and development plan for future efforts.
\end{comment}

